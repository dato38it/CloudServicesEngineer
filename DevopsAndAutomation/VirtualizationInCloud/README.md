# Виртуализация в Yandex Cloud
<p><strong>Task:</strong><br />Для защиты практической работы по теме "Виртуализация в Yandex Cloud" настроил в Yandex Cloud больше десятка виртуальных машин на базе OC Linux<br /><strong>Task:</strong><br />Создание аккаунта. Для того, чтобы работать в облаке, нужен платёжный аккаунт. Если это ваш первый аккаунт в Yandex Cloud, то после его создания вы сможете активировать 60-дневный пробный период и получить стартовый грант. Это позволит вам выполнять практические работы, не тратя собственных средств.<br /><strong>Decision:</strong><br />Если у вас нет личного платёжного аккаунта: Откройте в браузере сайт cloud.yandex.ru. Если вы не авторизованы, в правом верхнем углу или на баннере нажмите кнопку Подключиться. - Войдите в свой аккаунт на Яндексе. - Если у вас его нет, то вам будет предложено создать новый Яндекс ID. При регистрации в Яндекс ID заполните все поля, в том числе номер телефона: он потребуется, чтобы создать платёжный аккаунт в Yandex Cloud. - Примите условия использования Yandex Cloud. - После аутентификации при первом входе в консоль управления вам будет предложено создать облако. Укажите название облака и нажмите кнопку Создать. - Вам будет назначена роль владельца &mdash; owner. - На этом этапе у вас есть облако, но нет платёжного аккаунта. Если вы перейдете в раздел Биллинг (в левом верхнем углу выберите меню Все сервисы -&gt; Биллинг), то увидите, что в списке аккаунтов пока пусто. - Чтобы создать платёжный аккаунт, нажмите кнопку Создать аккаунт в разделе Биллинг или на стартовой странице. При создании аккаунта заполните все данные (выберите тип плательщика &mdash; Физическое лицо) и добавьте банковскую карту. Для проверки система спишет с неё небольшую сумму денег, а затем сразу вернёт на счёт. - Важно! Обязательно выберите опцию Включить пробный период. Если этого не сделать, то ваш платежный аккаунт будет сразу переведен в режим платного потребления. - Пробный период позволяет использовать ресурсы Yandex Cloud в ограниченном режиме в течение 60 дней. Потреблённые ресурсы оплачиваются из стартового гранта. После завершения пробного периода ваши ресурсы в облаке будут остановлены, а чтобы возобновить работу в полном объёме потребуется перейти на платную версию. - Важно! Не отвязывайте банковскую карту во время пробного периода: в этом случае облако заблокируется. Если вы не перейдёте на платную версию, средства с карты списываться не будут.<br />$ google-chrome https://cloud.yandex.ru/ &amp;<br />После аутентификации при первом входе в консоль управления вам будет предложено создать облако. Укажите название облака и нажмите кнопку Создать. Вам будет назначена роль владельца &mdash; owner.<br />Чтобы создать платёжный аккаунт, нажмите кнопку Создать аккаунт в разделе Биллинг или на стартовой странице. При создании аккаунта заполните все данные (выберите тип плательщика &mdash; Физическое лицо) и добавьте банковскую карту. Для проверки система спишет с неё небольшую сумму денег, а затем сразу вернёт на счёт.<br /><strong>Task:</strong><br />Создать ВМ на базе OC Linux из консоли управления.<br /><strong>Decision:</strong><br />Откройте консоль управления облаком. Если это новое облако, которое вы создали в предыдущей практической работе, то вы окажетесь на странице дашборда каталога с именем default. Этот каталог и облачная сеть в нём с таким же именем создаются вместе с облаком автоматически.<br />Выберите сервис Compute Cloud из списка (Дашборд каталога &rarr; Все сервисы &rarr; Compute Cloud) и нажмите кнопку Создать ВМ.<br />В открывшемся окне понадобится указать параметры создаваемой ВМ. В блоке Базовые параметры укажите Имя ВМ, оно может содержать строчные латинские буквы, цифры и дефисы. Поле Описание необязательное &mdash; его обычно заполняют, чтобы не запутаться, если ВМ несколько. Выберите из списка Зону доступности ru-central1-a.<br />На вкладке Операционные системы В блоке Выбор образа/загрузочного диска выберите ОС, которая будет установлена на ВМ, &mdash; Ubuntu 22.04.<br />В блоке Диски оставьте значения по умолчанию: тип &mdash; HDD, размер &mdash; 18 ГБ.<br />В блоке Вычислительные ресурсы оставьте значения по умолчанию: платформа Intel Ice Lake, 2 ядра виртуального процессора (vCPU), гарантированная доля vCPU 100% и объём оперативной памяти (RAM) 2 ГБ.<br />В блоке Сетевые настройки оставьте используемую по умолчанию подсеть, а для Публичного адреса и Внутреннего адреса &mdash; опцию Автоматически.<br />В блоке Доступ заполните поле Логин&nbsp; (имя пользователя создаваемой ВМ).<br />Не указывайте идентификатор root или другие имена, зарезервированные операционной системой. Для операций, требующих прав суперпользователя, нужно будет использовать команду sudo.<br />Чтобы подключиться к создаваемой ВМ по протоколу SSH, понадобится пара SSH-ключей. Открытый ключ хранится на ВМ, а закрытый &mdash; у пользователя. В публичных образах Linux, предоставляемых Yandex Cloud, возможность подключения по SSH с использованием логина и пароля по умолчанию отключена.<br />создать SSH-ключи<br />После выполнения команды укажите имена файлов, куда сохранятся ключи, и введите пароль для закрытого ключа. По умолчанию используется имя id_rsa, ключи создаются в папке ~/.ssh текущего пользователя.<br />Открытый ключ сохранится в файле &lt;имя_ключа&gt;.pub. Содержимое этого файла вставляется в поле SSH-ключ виртуальной машины.<br />В поле SSH-ключ вставьте содержимое созданного открытого ключа. Убедитесь, что вставляете ключ без переносов строки. Например: ssh-rsa AAAAB3NzaC1yc2EAAAABJQAAAQEAoIT+oFLFEHwNlGO71wZiamqHkzduK7V/B8ITxgLnddm725QZJbaO1JAUfaOryGckWqEHr0NQxZ+CfozLjtYwcYhnPfNs1vw7Ii5gnL4ne+Vu5Kl4f8rb+tOXAv6GAZIO1+05kB8K3nINfBkKFD1J0VmOr5P2MWy7aqdbyIqVJCH+YeU4SW5RGFPJbl5zGhlwSavVU0bgTYQmqWAOnR95bQVx1vRf4SyB003C8MYl8ccZ+emixM12eQPJ74fJyy1kKLRmU/IAlxyEiYESQglAaNQKN2ivnbfMaSVBnxMlYipxyeMDyCs8RD7zVUndTOJQg8PV7QVWqfAQjlY4uYlk8Q== rsa-key-20210429 <br />Изменяя параметры ВМ, в блоке Тарифы и цены (справа) вы увидите, как меняется её месячная стоимость.<br />Нажмите кнопку Создать ВМ.<br />Развёртывание ВМ занимает несколько минут. Вы можете отслеживать этот процесс по смене статуса.<br />Статус ВМ влияет на то, какие операции вы можете с ней выполнять. Например, статус Stopped означает, что машина остановлена и к ней невозможно подключиться. При запуске статус меняется на Provisioning (Yandex Cloud выделяет ВМ ресурсы), а после загрузки операционной системы &mdash; на Running.<br />Теперь, когда ВМ создана и запущена, к ней можно подключиться. Для этого понадобятся логин пользователя и публичный IP-адрес ВМ, который можно скопировать из строки с информацией о ней на странице Виртуальные машины.<br />Чтобы подключиться к запущенной ВМ (статус RUNNING) по протоколу SSH, используют утилиту ssh в Linux/macOS или Windows 10/11, программу PuTTY в Windows 7/8 или любой другой клиент SSH.<br />Если у вас несколько закрытых ключей, укажите нужный: ssh -i &lt;путь_к_ключу/имя_файла_ключа&gt; &lt;имя_пользователя&gt;@&lt;публичный_IP-адрес_ВМ&gt; <br />Установите обновления.<br />ВМ готова к работе<br /><strong>Decision:</strong><br />$ ssh-keygen -t rsa -b 2048<br />$ cat davidk.pub<br />$ ssh -i davidk david@178.154.223.142<br />$ sudo apt-get update<br />$ sudo apt-get upgrade<br /><strong>Task:</strong><br />Работа серийной консоли зависит от настроек операционной системы. Yandex Compute Cloud обеспечивает канал связи между пользователем и COM-портом ВМ, но не гарантирует стабильность работы консоли со стороны операционной системы ВМ.<br />Доступ к серийной консоли ВМ с ОС на базе Linux возможен следующими способами: по протоколу SSH с другого компьютера; через консоль управления Yandex Cloud; с помощью интерфейса командной строки Yandex Cloud CLI. <br /><strong>Task:</strong><br />Вход по протоколу SSH. Подключитесь к ВМ по протоколу SSH. Установите пароль текущему пользователю с помощью утилиты passwd в привилегированном режиме: sudo passwd &lt;имя_пользователя&gt; <br />После ввода команды дважды наберите одинаковый пароль.<br />Для доступа к серийной консоли ВМ необходимо знать её идентификатор (ID). В консоли управления перейдите в раздел Compute Cloud. По умолчанию откроется страница со списком ВМ. В столбце справа указан идентификатор каждой ВМ.<br />Используйте для входа идентификатор ВМ и имя (логин) созданного в ней пользователя. Вот шаблон команды подключения для Linux: ssh -t -p 9600 -o IdentitiesOnly=yes -i ~/.ssh/&lt;имя закрытого ключа&gt; &lt;ID виртуальной машины&gt;.&lt;имя пользователя&gt;@serialssh.cloud.yandex.net <br />Вот так вы подключитесь к консоли, если в ВМ с ID fhm0b28lgfp4tkoa3jl6 есть пользователь yc-user: ssh -t -p 9600 -o IdentitiesOnly=yes -i ~/.ssh/id_rsa fhm0b28lgfp4tkoa3jl6.yc-user@serialssh.cloud.yandex.net <br />Чтобы отключиться от серийной консоли, нажмите клавишу Enter, а затем введите символы ~. (тильда и точка). В терминалах Linux для отключения также можно использовать комбинацию клавиш Ctrl + D.<br /><strong>Task:</strong><br />Вход через консоль управления<br /><strong>Decision:</strong><br />В консоли управления откройте страницу ВМ и через меню слева перейдите на страницу Серийная консоль. При авторизации используйте логин, указанный при создании ВМ, и пароль, который вы установили после подключения к ней.<br /><strong>Decision:</strong><br />$ sudo passwd david<br />$ exit<br />$ ssh -t -p 9600 -o IdentitiesOnly=yes -i davidk fhmm3t1r6n0e6s5q2u3h.david@serialssh.cloud.yandex.net<br /><strong>Task:</strong><br />Создаем ВМ с 5% vCPU и учимся использовать мониторинг<br />Давайте создадим ВМ с гарантированной долей vCPU, равной 5%, и проверим её производительность.<br /><strong>Decision:</strong><br />В консоли управления перейдите в раздел Compute Cloud и нажмите кнопку Создать ВМ. Заполните имя и описание, выберите операционную систему CentOS 7.<br />В блоке Вычислительные ресурсы выберите платформу Intel Cascade Lake и укажите гарантированную долю vCPU 5%. Другие параметры оставьте по умолчанию.<br />После создания и запуска ВМ в списке машин нажмите её название. Вы перейдёте на страницу ВМ. Затем на левой боковой панели выберите Мониторинг. Откроется страница, где в динамике показывается информация о загрузке процессора, операциях с диском и сетевой активности. По умолчанию видны данные за одни сутки (1d &mdash; 1 day).<br />Переключитесь на один час: вверху слева нажмите 1h (1 hour).<br />На графике видно, что при запуске использование процессорных ресурсов было высоким, а позже снизилось до приемлемого. Чтобы посмотреть точные значения в определённый момент, поместите указатель над линией графика. Вы увидите всплывающее окно с показателями для этой точки времени.<br />Теперь удалите ВМ. Для этого сначала остановите её &mdash; вернитесь в список ВМ, отметьте нужную ВМ и на появившейся внизу контекстной панели нажмите Остановить.<br />Во всплывающем окне подтвердите действие и нажмите кнопку Остановить. Дождитесь смены статуса на Stopped.<br />Чтобы удалить ВМ, в списке ВМ справа напротив машины нажмите ... и в раскрывшемся меню выберите Удалить. Подтвердите действие. Через некоторое время ВМ будет удалена.<br /><strong>Task:</strong><br />Создаем снимок диска ВМ<br />Допустим, вы планируете обновить ПО на виртуальной машине ВМ. Вы знаете, что взаимодействие приложений и системных сервисов после обновления может нарушиться, а данные могут быть повреждены. Поэтому хотите иметь резервную копию полностью работоспособной системы на случай неудачи.<br />Давайте на практике разберём, как сделать снимок и восстановить из него ВМ при повреждении системы. Для этого используем ВМ, на которой развернута система на основе Ubuntu или CentOS.<br /><strong>Decision:</strong><br />В первую очередь обеспечьте целостность данных. Для этого подключитесь к ВМ по SSH. Чтобы записать кеш операционной системы на диск, выполните команду sync (иначе изменения файлов, хранящиеся в оперативной памяти, будут потеряны). Диски в Linux монтируются в ОС в виде файлов. Чтобы узнать нужный файл устройства диска, выполните команду df -h для вывода полного списка устройств и соответствующих точек монтирования. Затем, чтобы заморозить файловую систему, выполните команду fsfreeze -f &lt;точка монтирования&gt;.<br />В консоли управления откройте раздел Compute Cloud и перейдите на вкладку Диски. Справа от диска нажмите ... и выберите Создать снимок.<br />В открывшемся окне вы увидите автоматически сформированное имя снимка диска. Оно состоит из идентификатора диска и идентификатора снимка. Вы можете переименовать снимок и заполнить его описание. После этого нажмите кнопку Создать.<br />Откройте Снимки дисков. Как только снимок будет создан, статус операции сменится с Creating на Ready.<br />Разморозьте файловую систему. Для этого в командной строке с интерфейсом подключения к ВМ по SSH выполните команду fsfreeze --unfreeze &lt;точка монтирования&gt;.<br />Теперь протестируйте обновление системы: в командной строке с интерфейсом подключения к ВМ по SSH последовательно выполните команды apt-get update и apt-get dist-upgrade. Дождитесь, пока обновление завершится. Важно! Перед выполнением следующей команды убедитесь в том, что находитесь в консоли именно тестовой ВМ.<br />Сымитируйте повреждение системы: выполните команду sudo rm -rf --no-preserve-root /. Вы увидите предупреждение, что все данные на диске будут удалены. Подтвердите своё намерение.<br />Поскольку снимок создан с загрузочного диска, который всегда подключён к ВМ, для восстановления создайте новую ВМ вместо старой. При создании загрузочного диска машины выберите готовый снимок диска. Для этого в блоке Выбор образа/загрузочного диска перейдите на вкладку Пользовательские и нажмите кнопку Выбрать. В открывшемся окне перейдите на вкладку Снимок, выберите нужный снимок и нажмите кнопку Применить.<br />Дождитесь завершения создания и запуска новой ВМ. Теперь старую ВМ можно остановить и удалить.<br /><strong>Decision:</strong><br />$ ssh -i ubcloud test138@51.250.93.58<br />$ sudo fsfreeze -f /mnt<br />$ sudo fsfreeze --unfreeze /mnt<br />$ sudo apt-get update<br />$ sudo apt-get dist-upgrade<br />$ sudo rm -rf --no-preserve-root /<br /><strong>Task:</strong><br />Создание новой сети с подсетями и ВМ. <br />Облачные сети (сервис Virtual Private Cloud или VPC) являются частью публичного облака, которая связывает пользовательские, инфраструктурные, платформенные и прочие ресурсы воедино, где бы они ни находились &mdash; в нашем облаке или за его пределами. При этом VPC позволяет не публиковать эти ресурсы в интернете без необходимости, они остаются в пределах вашей изолированной сети.<br />Когда вы создаёте облако, в нём автоматически создаются сеть default и подсети в каждой зоне доступности. Но иногда их бывает недостаточно. В этой практической работе вы научитесь создавать облачную сеть и добавлять подсети самостоятельно.<br />Рассмотрим пример, как настроить облачную сеть, чтобы организовать работу сервера с доступом из интернета. <br />Сначала создадим единую для всех ресурсов облака изолированную сеть с подсетями и виртуальной машиной.<br /><strong>Decision:</strong><br />В консоли управления перейдите на страницу сервиса Virtual Private Cloud (Дашборд каталога &rarr; Virtual Private Cloud) и нажмите кнопку Создать сеть вверху справа. Введите имя сети (пусть она называется yc), поле Описание заполнять необязательно. Оставьте выбранной опцию Создать подсети и нажмите кнопку Создать сеть. В результате будут созданы сеть yc и три подсети: yc-ru-central1-a, yc-ru-central1-b и yc-ru-central1-c.<br />Для сервера создадим ещё одну подсеть с маской /28. Перейдите на страницу сети yc (Дашборд каталога &rarr; Virtual Private Cloud &rarr; сеть yc) и нажмите кнопку Добавить подсеть. Введите параметры подсети: Имя &mdash; yc-public, Зона &mdash; ru-central1-a, CIDR &mdash; 192.168.0.0/28. Нажмите кнопку Создать подсеть.<br />Доступом пользователей облака к сетевым ресурсам управляют с помощью назначения ролей.<br />Теперь создайте ВМ с именем web-server и ОС Ubuntu 22.04. Убедитесь, что в блоке Базовые параметры выбрана зона доступности ru-central1-a. В блоке Сетевые настройки выберите Подсеть yc-public. В блоке Доступ введите логин пользователя (например user) и вставьте открытый SSH-ключ в соответствующее поле. Чтобы ВМ полноценно заработала, для неё нужно организовать доступ в интернет. Есть три способа:<br />- Назначить ВМ публичный IP-адрес. Для этого выберите автоматический способ назначения IP-адреса, когда создаёте ВМ, или привяжите его к уже созданной.<br />- Использовать NAT-шлюз, который позволяет дать ВМ доступ в интернет без назначения ей публичного IP-адреса. Самому шлюзу адрес выделяется из отдельного диапазона публичных IP-адресов.<br />- Использовать NAT-инстанс &mdash; отдельную ВМ со статическим публичным IP-адресом и настроенными правилами маршрутизации трафика.<br />С точки зрения безопасности лучше выбирать второй или третий способ. В этом примере для упрощения присвойте ВМ публичный IP-адрес &mdash; в поле Публичный адрес выберите опцию Автоматически.<br />После создания ВМ проверьте её доступность, чтобы убедиться в том, что сетевая конфигурация настроена правильно. Для этого перейдите на страницу Обзор созданной ВМ (Дашборд каталога &rarr; Compute Cloud &rarr; ВМ web-server) и в блоке Сеть найдите её публичный IP-адрес. Откройте интерфейс командной строки на своём компьютере и введите команду:<br />$ ping 51.250.78.143 <br /><strong>Task:</strong><br />Давайте попробуем создать группу безопасности и сделать доступными страницы, предоставляемые веб-сервером NGINX.<br /><strong>Decision:</strong><br />Перейдите по ссылке https://console.cloud.yandex.ru/link/vpc/security-groups и нажмите кнопку Создать группу.<br />Введите имя группы yc-security и выберите сеть yc.<br />В блоке Правила добавьте правила для исходящего трафика. Опишите правило, укажите диапазон портов 80 (HTTP) и протокол TCP, выберите назначение "CIDR" 0.0.0.0/0 . Создайте аналогичные исходящие правила для портов 443 (HTTPS) и 22 (SSH). Для входящего трафика добавьте правила для 80 и 22 портов, чтобы подключаться к веб-серверу и управлять ВМ извне. Вы увидите созданную группу в списке групп безопасности. Если инициировано соединение по определенному порту и протоколу с ВМ и есть исходящее правило, то значит и на входящий трафик будет разрешена передача данных в эту же сеть, на этот же протокол и порт. Если назначить сетевому интерфейсу ВМ группу безопасности без правил, ВМ не сможет передавать и принимать трафик.<br />Создайте виртуальную машину на базе Ubuntu 20.04, выберите сеть yc и вновь созданную группу безопасности yc-security в сетевых настройках создаваемой ВМ, дождитесь запуска машины, подключитесь к ВМ по SSH и установите веб-сервер NGINX (по умолчанию он отсутствует). Для этого выполните команду:<br />Установка возможна, поскольку вы открыли порт 80: команда apt-get использует его для получения пакетов с ПО.<br />После установки сервер автоматически запустится и будет доступен извне благодаря открытому порту 80. Проверьте это, зайдя через браузер на публичный IP-адрес ВМ, который найдёте на странице параметров машины в консоли управления.<br /><strong>Decision:</strong><br />$ sudo apt-get install nginx<br /><strong>Task:</strong><br />Знакомство с Yandex Cloud CLI.<br /><strong>Decision:</strong><br />Развернём две ВМ, запустим на них веб-серверы NGINX и поместим их за балансировщик. Создавать ВМ через консоль управления облаком вы уже умеете. Вот только для реальных проектов часто приходится разворачивать далеко не одну-две ВМ. В этом случае работать через консоль управления долго и неудобно, да и вероятность ошибиться, выполняя много однотипных операций вручную, растёт. Решить эту проблему можно с помощью автоматизации, а один из самых простых способов это сделать &mdash; использовать интерфейс командной строки (CLI, Command Line Interface).<br />Установите на свой компьютер утилиту yc, которая представляет собой интерфейс командной строки Yandex Cloud CLI, и настройте её (создайте профиль) по инструкции в документации.<br />Создайте файл startup.sh Скрипт, который получает список актуальных пакетов с софтом, устанавливает и запускает NGINX, а затем меняет информационную страницу работающего сервера.<br />Создайте первую ВМ с помощью команды yc compute instance create. Чтобы указать, какую именно ВМ мы хотим создать, в команде используются параметры. В данном случае &mdash; имя ВМ (--name demo-1), откуда взять метаданные (из файла скрипта startup.sh, созданного ранее), из какого образа создать загрузочный диск (ubuntu-2004-lts), в какой зоне создать машину (--zone ru-central1-a) и в какую подсеть подключить сетевой интерфейс с IPv4-адресом (--network-interface ...).<br />Самостоятельно измените и запустите еще раз эту команду, чтобы создать такую же ВМ с именем demo-2.<br />Теперь проверим, что обе ВМ успешно созданы. Это можно сделать, заглянув в консоль управления. А можно и из командной строки с помощью команды yc compute instance list. Попробуйте этот способ. <br />Убедитесь, что статус машин сменился на Running, а скрипт выполнился (иногда нужно подождать до одной минуты, пока обновится список пакетов и установится NGINX).<br />Введите публичные IP-адреса ВМ в браузере и проверьте, что главные страницы веб-серверов доступны<br /><strong>Decision:</strong><br />$ curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash<br />$ sudo reboot<br />$ yc init<br />$ yc config list<br />$ yc resource-manager folder add-access-binding default \<br />--role compute.images.user \<br />--subject system:allAuthenticatedUsers<br />$ yc compute image list --folder-id standard-images<br />$ vim startup.sh<br />$ cat startup.sh<br />#!/bin/bash<br />apt-get update<br />apt-get install -y nginx<br />service nginx start<br />sed -i -- "s/nginx/Yandex Cloud - ${HOSTNAME}/" /var/www/html/index.nginx-debian.html<br />EOF<br />$ chmod +x startup.sh<br />$ yc compute instance create \<br />--name tcloud-ubuntu3 \<br />--hostname tcloud-ubuntu3 \<br />--metadata-from-file user-data=startup.sh \<br />--create-boot-disk image-folder-id=standard-images,image-family=ubuntu-2004-lts \<br />--zone ru-central1-a \<br />--network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4<br />$ yc compute instance create \<br />--name tcloud-ubuntu4 \<br />--hostname tcloud-ubuntu4 \<br />--metadata-from-file user-data=startup.sh \<br />--create-boot-disk image-folder-id=standard-images,image-family=ubuntu-2004-lts \<br />--zone ru-central1-a \<br />--network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4<br />$ yc compute instance list<br /><strong>Task:</strong><br />Создание балансировщика<br />Итак, у вас есть виртуальные машины. Можно сразу создать и балансировщик, и целевую группу, но мы поступим иначе: сначала создадим целевую группу, затем подключим её к балансировщику.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Network Load Balancer, на вкладке Целевые группы нажмите кнопку Создать целевую группу. На открывшейся странице введите имя целевой группы (например demo-web), выберите обе ВМ, созданные на предыдущем уроке, и нажмите кнопку Создать.<br />Остаётся создать балансировщик. Для этого сначала создайте обработчик и настройте проверку состояния ресурсов в целевой группе:<br />На вкладке Балансировщики нажмите кнопку Создать сетевой балансировщик.<br />Заполните имя балансировщика (например lb-demo-web) и нажмите кнопку Добавить обработчик.<br />В открывшемся окне введите имя обработчика (например demo-web-listener). В качестве портов укажите 80и нажмите кнопку Добавить.<br />После создания обработчика нажмите кнопку Добавить целевую группу. Укажите имя проверки состояния (например hc-demo-web), тип проверки (HTTP), порт (80), интервал отправки проверок состояния в секундах, порог работоспособности и порог неработоспособности. Оставьте указанный по умолчанию путь для проверок, используйте значения по умолчанию и для других параметров. Нажмите кнопку Применить, а затем кнопку Создать.<br />После создания балансировщика проверьте состояние ресурсов: в консоли управления откройте страницу балансировщика и убедитесь, что его статус &mdash; Active. Значит, балансировщик готов передавать трафик целевым ресурсам.<br />Перейдите на страницу балансировщика и посмотрите на блок Целевые группы. У запущенных ВМ, готовых принимать трафик, будет статус Healthy.<br />Введите внешний IP-адрес балансировщика в адресную строку браузера &mdash; и балансировщик перенаправит вас на одну из машин целевой группы. Обратите внимание на имя ВМ, указанное во второй строке веб-страницы.<br />Чтобы протестировать отказоустойчивость, в консоли управления перейдите в раздел Compute Cloud и остановите одну из ВМ целевой группы.<br />Вернитесь на страницу балансировщика и убедитесь, что статус остановленной ВМ изменился на Unhealthy. Это означает, что целевой ресурс группы не прошёл проверку состояния и не готов принимать трафик.<br />Обновите страницу с IP-адресом балансировщика, и вы увидите, что трафик перенаправлен на другую ВМ (изменилось имя ВМ, указанное во второй строке веб-страницы).<br />После завершения работы не забудьте удалить использованные ресурсы: две ВМ и балансировщик.<br /><strong>Task:</strong><br />Создание группы виртуальных машин<br />Иногда вам требуется не автоматическое масштабирование, а автоматическое восстановление ВМ. <br />Например, если вы отлаживаете работу веб-сервиса, который периодически падает. <br />Для этого подойдут группы ВМ фиксированного размера. Давайте создадим и настроим такую группу.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud, перейдите на вкладку Группы виртуальных машин и нажмите кнопку Создать группу.<br />Откроется страница Создание группы виртуальных машин.<br />В блоке Базовые параметры введите имя и описание группы ВМ. Создайте новый сервисный аккаунт. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль editor. По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.<br />ВМ группы могут находиться в разных зонах и регионах. В блоке Распределение выберите две зоны доступности, чтобы обеспечить доступность сервиса, если в одной из них случится сбой.<br />В блоке Шаблон виртуальной машины нажмите кнопку Задать.<br />Шаблон создается так же, как и сама ВМ. В блоке Базовые параметры введите описание шаблона конфигурации, затем в блоке Выбор образа/загрузочного диска на вкладке Операционные системы выберите Ubuntu.<br />В блоках Диски и Вычислительные ресурсы для загрузочного диска оставьте значения по умолчанию. В блоке Сетевые настройки выберите существующую сеть и подсеть или создайте новые. В блоке Доступ выберите существующий или создайте новый сервисный аккаунт, укажите логин, вставьте в поле SSH-ключ содержимое файла с публичным ключом, доступ к серийной консоли не разрешайте.<br />Сохраните параметры и вы вернётесь на страницу Создание группы виртуальных машин.<br />В блоке В процессе создания и обновления разрешено установите политику развертывания: Добавлять выше целевого значения (на сколько ВМ можно превышать размер группы) &mdash; 2. Уменьшать относительно целевого значения (на сколько ВМ можно уменьшать размер группы) &mdash; 1. Одновременно создавать (сколько ВМ можно сразу создавать в группе) &mdash; 2. Время запуска (сколько времени должно пройти, прежде чем будут пройдены все проверки состояния и ВМ начнет получать нагрузку) &mdash; 2 минуты. Одновременно останавливать (сколько ВМ можно сразу удалять) &mdash; 1. Останавливать машины по стратегии &mdash; Принудительная. При принудительной стратегии Instance Groups самостоятельно выбирает, какие ВМ остановить.<br />В блоке Масштабирование выберите фиксированный тип, Размер (количество ВМ) &mdash; 3.<br />В блоке Интеграция с Load Balancer оставьте опцию Создать целевую группу выключенной. Не включайте пока проверку состояний, которая позволяет Instance Groups получать сведения о состоянии ВМ.<br />Нажмите кнопку Создать и вернитесь на страницу Группы виртуальных машин. В правом нижнем углу появится сообщение &laquo;Группа виртуальных машин создаётся&raquo;. Одновременно можно создавать не более двух ВМ. Поэтому сначала будут созданы две ВМ, потом &mdash; третья.<br />После того как вы создали группу, протестируйте включение и выключение всех машин сразу. Обратите внимание: в соответствии с настройками сервис инициирует запуск не более двух машин одновременно. Третья ВМ будет оставаться остановленной. Как только первая будет запущена, один слот на запуск освободится, поэтому сразу будет инициирован запуск третьей и последней ВМ.<br /><strong>Task:</strong><br />Автоматическое масштабирование под нагрузкой<br />Давайте разберёмся, как обеспечить доступность сервиса под высокой нагрузкой. Вы уже научились создавать группы ВМ. Теперь создадим автоматически масштабируемую группу ВМ.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud. Перейдите на вкладку Группы виртуальных машин и нажмите кнопку Создать группу. Задайте имя группе ВМ.<br />Создайте сервисный аккаунт. Чтобы иметь возможность создавать, обновлять и удалять ВМ в группе, назначьте сервисному аккаунту роль editor. По умолчанию все операции в группе ВМ выполняются от имени сервисного аккаунта.<br />В блоке Распределение выберите только одну зону доступности.<br />В блоке Шаблон виртуальной машины нажмите кнопку Задать. В открывшемся окне выберите: ОС: Ubuntu 20.04. Размер загрузочного диска: 50 ГБ. Тип загрузочного диска: SSD.<br />Остальные параметры &mdash; по умолчанию. Не забудьте добавить публичный SSH-ключ. Он понадобится нам на следующем практическом занятии.<br />В блоке В процессе создания и обновления разрешено оставьте параметры по умолчанию.<br />Перейдите к блоку Масштабирование и выберите тип Автоматический.<br />Задайте параметры масштабирования: Тип автомасштабирования &mdash; зональное. При зональном автомасштабировании количество ВМ регулируется отдельно в каждой зоне доступности, указанной в настройках группы. Минимальное количество ВМ в зоне &mdash; 2. Сервис Instance Groups не будет удалять ВМ в зоне доступности, если их там всего две. Максимальный размер группы &mdash; 4. Instance Groups не будет создавать ВМ, если их уже четыре. В этот раз размер загрузочного диска ВМ &mdash; 50 ГБ, поэтому с учётом квот на суммарный объём SSD-дисков в одном облаке смогут запуститься четыре ВМ. Промежуток измерения загрузки (это период усреднения: время, за которое следует усреднять замеры нагрузки для каждой ВМ в группе) &mdash; 60 секунд. Время на разогрев ВМ &mdash; 3 минуты. В течение этого времени ВМ не учитывается в измерении средней нагрузки на группу. Фактически данное время мы можем определить, измерив, как быстро запускается ВМ. Период стабилизации &mdash; 5 минут. Отсчитывается с момента, когда Compute Cloud принял последнее решение о том, что количество ВМ в группе нужно увеличить. Начальный размер группы &mdash; 4. Это количество ВМ, которое следует создать вместе с группой.<br />В блоке Метрики укажите: Тип &mdash; CPU. Целевой уровень загрузки CPU, % &mdash; 80. Instance Groups будет управлять размером группы так, чтобы поддерживать указанную нагрузку CPU.<br />Нажмите кнопку Создать. Сервис начнет создавать ВМ. После создания статус группы изменится на Active. Обратите внимание, как меняются Состояния ВМ.<br />Creating instance &mdash; ВМ создаётся и запускается. Awaiting warmup duration &mdash; ВМ начинает принимать сетевой трафик. В этом статусе ВМ находится в течение периода прогрева, указанного в настройках автоматического масштабирования. Значения метрик ВМ в этом статусе заменяются средними значениями ВМ из той же зоны доступности. Running actual &mdash; ВМ запущена, на неё подается сетевой трафик, пользовательские приложения работают.<br />Группа ВМ готова принимать рабочую нагрузку.<br /><strong>Task:</strong><br />Воссоздание виртуальных машин в группе.<br />Давайте сымитируем рост нагрузки на ВМ и посмотрим, как сервис на это отреагирует.<br /><strong>Decision:</strong><br />В консоли управления откройте раздел Compute Cloud и перейдите на страницу группы ВМ, которую вы создали на прошлом практическом занятии. Откройте в двух вкладках браузера страницы Группы виртуальных машин и Мониторинг (открывается из раздела Группы виртуальных машин).<br />После запуска группы зайдите по SSH на каждую из двух ВМ и установите приложение для стресс-тестирования Linux-систем. Для этого выполните команду: sudo apt-get install stress <br />После этого для каждой ВМ запустите установленное приложение: stress -c 2 <br />Аргумент -c означает, что при тестировании будет нагружаться процессор, а число после аргумента задаёт количество ядер процессора, которые будут нагружаться. Чтобы эксперимент удался &mdash; укажите количество ядер, которое вы выбрали в шаблоне ВМ. На вкладке со страницей мониторинга на графике Average CPU utilization in ru-central1-a следите за тем, как усреднённое значение нагрузки будет постепенно расти.<br />Как только усреднённое значение нагрузки превысит порог, сервис Instance Groups начнёт прогревать две дополнительные ВМ и вводить их в строй. Это будет видно на странице Группы виртуальных машин.<br />Поскольку стресс-тест не остановлен, сервис завершает запуск двух ВМ.<br />Через некоторое время усреднённое значение нагрузки процессоров в группе упадёт до 50%, поскольку первая половина ВМ загружена полностью, а вторая не загружена вовсе. Остановите работу стресс-теста на первой ВМ. В командной строке используйте сочетание клавиш Ctrl + C.<br />Через некоторое время усреднённое значение достигнет 25%, тогда Instance Groups удалит лишнюю ВМ. Остановите второй стресс-тест. Через некоторое время после того, как усредненное значение достигнет нуля, Instance Groups удалит вторую дополнительную ВМ. При минимальной нагрузке остаются работать две машины.<br />Вот так при растущей нагрузке группа ВМ автоматически масштабируется, чтобы обеспечить доступность ресурса.<br /><strong>Decision:</strong><br />$ ssh -i YOUR-KEY YOUR-USERNAME1@YOUR-IP1<br />$ sudo apt-get install stress <br />$ stress -c 2<br />$ ssh -i YOUR-KEY YOUR-USERNAME2@YOUR-IP2<br />$ sudo apt-get install stress <br />$ stress -c 2</p>
